<!DOCTYPE html>
<html lang="en">
<head>

<link rel="icon" type="image/png" href="../favicon.png">
<link rel="icon" type="image/x-icon" href="../favicon.ico">

<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Market Stats | 615 Realty Guy</title>

<style>

/* ============================= */
/* GLOBAL SITE STYLES */
/* ============================= */

body {
    font-family: 'Futura', sans-serif;
    background-color: #000000;
    color: #d2b56c;
    margin: 0;
    padding: 0;
    text-align: center;
}

/* Gold Gradient Headings */
h1, h2 {
    background: linear-gradient(to right, #feee9f, #b18841);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
}

/* Header */
header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 15px 40px;
    background: black;
    gap: 16px;
}

.logo img {
    max-width: 100px;
}

nav {
    display: flex;
    gap: 20px;
    align-items: center;
    flex-wrap: wrap;
}

nav a {
    color: #d2b56c;
    text-decoration: none;
    font-weight: bold;
    transition: 0.3s;
}

nav a:hover {
    color: #feee9f;
}

/* CTA Button */
.cta-btn {
    display: inline-flex;
    align-items: center;
    gap: 10px;
    padding: 10px 14px;
    border-radius: 14px;
    border: 1px solid rgba(210,181,108,0.35);
    background: linear-gradient(180deg, rgba(210,181,108,0.22), rgba(210,181,108,0.08));
    box-shadow: 0 12px 30px rgba(0,0,0,0.45);
    font-weight: 800;
    font-size: 13px;
    letter-spacing: .2px;
}

.cta-btn:hover {
    border-color: rgba(254,238,159,0.60);
}

.cta-dot {
    width: 8px;
    height: 8px;
    border-radius: 99px;
    background: #d2b56c;
    box-shadow: 0 0 0 4px rgba(210,181,108,0.15);
}

/* ============================= */
/* RATE CARD */
/* ============================= */

.rate-card {
    max-width: 760px;
    margin: 60px auto 30px auto;
    padding: 26px;
    background: linear-gradient(145deg, #0f0f12, #1a1a1f);
    border: 1px solid rgba(210,181,108,0.25);
    border-radius: 16px;
    box-shadow: 0 25px 50px rgba(0,0,0,0.6);
    text-align: left;
}

.rate-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 14px;
    flex-wrap: wrap;
    margin-bottom: 12px;
}

.rate-title {
    font-size: 16px;
    letter-spacing: 1px;
    margin: 0;
    text-align: left;
}

/* Segmented Toggle */
.seg {
    display: inline-flex;
    border: 1px solid rgba(255,255,255,0.12);
    border-radius: 999px;
    overflow: hidden;
    background: rgba(0,0,0,0.35);
}

.seg button {
    appearance: none;
    border: 0;
    background: transparent;
    color: rgba(255,255,255,0.65);
    padding: 8px 12px;
    cursor: pointer;
    font-weight: 900;
    font-size: 12px;
    letter-spacing: .3px;
}

.seg button.active {
    color: #feee9f;
    background: linear-gradient(180deg, rgba(210,181,108,0.28), rgba(210,181,108,0.10));
}

.rate-row {
    display: flex;
    justify-content: space-between;
    align-items: flex-end;
    gap: 16px;
    flex-wrap: wrap;
}

.rate-value {
    font-size: 56px;
    font-weight: bold;
    background: linear-gradient(to right, #feee9f, #b18841);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
}

.rate-meta {
    text-align: right;
    display: flex;
    flex-direction: column;
    gap: 6px;
}

.rate-date {
    font-size: 13px;
    color: #999;
    margin: 0;
}

.status-pill {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    padding: 7px 10px;
    border-radius: 999px;
    border: 1px solid rgba(255,255,255,0.10);
    background: rgba(255,255,255,0.05);
    color: rgba(255,255,255,0.70);
    font-size: 12px;
    justify-content: flex-end;
}

.status-dot {
    width: 7px;
    height: 7px;
    border-radius: 99px;
    background: #3ddc97;
    box-shadow: 0 0 0 4px rgba(61,220,151,0.14);
}
.status-dot.bad {
    background: #ff5c5c;
    box-shadow: 0 0 0 4px rgba(255,92,92,0.12);
}

.err {
    color: rgba(255,255,255,0.90);
    background: rgba(255,92,92,0.10);
    border: 1px solid rgba(255,92,92,0.25);
    padding: 10px 12px;
    border-radius: 14px;
    font-size: 13px;
    display: none;
    margin-top: 10px;
}

/* Chart */
.chart-wrap {
    margin-top: 14px;
    border: 1px solid rgba(255,255,255,0.10);
    border-radius: 14px;
    background: rgba(0,0,0,0.18);
    overflow: hidden;
}

canvas { display: block; width: 100%; height: 220px; }

.chart-footer {
    display: flex;
    justify-content: space-between;
    gap: 10px;
    padding: 10px 12px;
    border-top: 1px solid rgba(255,255,255,0.08);
    color: rgba(255,255,255,0.60);
    font-size: 12px;
    flex-wrap: wrap;
}

/* ============================= */
/* MARKET WIDGET */
/* ============================= */

.market-widget{
    width: 800px;
    margin: 0 auto 80px auto;
    background: linear-gradient(145deg, #0f0f12, #1a1a1f);
    border-radius:16px;
    box-shadow:0 25px 60px rgba(0,0,0,0.6);
    overflow:hidden;
}

.widget-header{
    display:flex;
    justify-content:space-between;
    align-items:center;
    padding:12px 20px;
    background: rgba(0,0,0,0.3);
}

#marketSelect{
    background:#1e1e22;
    color:#fff;
    border:1px solid rgba(255,255,255,0.1);
    border-radius:8px;
    padding:8px 12px;
}

.widget-indicator{
    font-size:14px;
    color:#b18841;
}

.widget-frame{
    position:relative;
    width:100%;
    height:500px;
    background:#000;
}

.widget-frame iframe{
    position:absolute;
    inset:0;
    width:100%;
    height:100%;
    border:0;
    opacity:0;
    transition: opacity .5s ease;
}

.widget-frame iframe.active{
    opacity:1;
}

.nav{
    position:absolute;
    top:50%;
    transform:translateY(-50%);
    width:36px;
    height:36px;
    border-radius:50%;
    background: rgba(0,0,0,0.6);
    color:#fff;
    display:flex;
    align-items:center;
    justify-content:center;
    cursor:pointer;
    font-size:20px;
    border:1px solid rgba(255,255,255,0.2);
}

.nav.left{ left:15px; }
.nav.right{ right:15px; }

@media(max-width:900px){
    header{
        padding: 15px 18px;
    }
    .market-widget{
        width:95%;
    }
    .rate-card{
        margin-top: 40px;
        text-align: left;
    }
}

</style>
</head>

<body>

<header>
  <div class="logo">
    <a href="../index.html">
      <img src="https://i.imgur.com/Mue4Nnr.png" alt="615 Logo">
    </a>
  </div>

  <nav>
    <a href="../index.html">Home</a>
    <a href="../about.html">About</a>
    <a href="https://substack.com/@615realtyguy" target="_blank">Blog</a>

    <!-- CTA -->
    <!-- Change this link to your Calendly/contact page -->
    <a class="cta-btn" href="https://calendly.com/615realtyguy" target="_blank" rel="noopener">
      <span class="cta-dot" aria-hidden="true"></span>
      Thinking about buying/selling? Let’s Talk
    </a>
  </nav>
</header>

<!-- Mortgage Rate Card -->
<div class="rate-card">
  <div class="rate-header">
    <div class="rate-title" id="mortgageTitle">30-Year Fixed Mortgage Rate</div>

    <div class="seg" role="tablist" aria-label="Mortgage rate series">
      <button id="btn30" class="active" role="tab" aria-selected="true">30YR</button>
      <button id="btn15" role="tab" aria-selected="false">15YR</button>
    </div>
  </div>

  <div class="rate-row">
    <div class="rate-value" id="mortgageRate">--</div>

    <div class="rate-meta">
      <div class="status-pill" id="statusPill">
        <span class="status-dot" id="statusDot" aria-hidden="true"></span>
        <span id="statusText">Loading…</span>
      </div>
      <p class="rate-date" id="rateDate">—</p>
    </div>
  </div>

  <div class="chart-wrap">
    <canvas id="rateChart" width="1000" height="440"></canvas>
    <div class="chart-footer">
      <div id="rangeLabel">Range: —</div>
      <div id="sourceLabel">Source: FRED</div>
    </div>
  </div>

  <div class="err" id="errBox"></div>
</div>

<!-- Market Widget -->
<div class="market-widget">
  <div class="widget-header">
      <select id="marketSelect"></select>
      <div class="widget-indicator" id="indicator">—</div>
  </div>

  <div class="widget-frame" id="frameHost">
      <div class="nav left" id="btnPrev">‹</div>
      <div class="nav right" id="btnNext">›</div>
  </div>
</div>

<script>
/* ============================= */
/* ✅ EDIT THESE WORKER ENDPOINTS */
/* ============================= */
/**
 * You told me your worker returned:
 * {"ok":true,"series":"MORTGAGE30US","rate":6.09,"date":"2026-02-12","source":"FRED"}
 *
 * Put your real endpoints here:
 *  - One endpoint for 30-year
 *  - One endpoint for 15-year
 *
 * If you only have ONE endpoint right now, set ENDPOINT_15 to the same URL
 * and we’ll update the worker later.
 */
const ENDPOINT_30 = "https://fred-proxy.615realtyguy.workers.dev/mortgage?series=MORTGAGE30US";
const ENDPOINT_15 = "https://fred-proxy.615realtyguy.workers.dev/mortgage?series=MORTGAGE15US";

// If your worker supports history, we’ll use up to this many points
const HISTORY_POINTS = 52;

const SERIES = {
  "30": { id: "MORTGAGE30US", name: "30-Year Fixed Mortgage Rate" },
  "15": { id: "MORTGAGE15US", name: "15-Year Fixed Mortgage Rate" }
};

const el = {
  title: document.getElementById("mortgageTitle"),
  rateValue: document.getElementById("mortgageRate"),
  rateDate: document.getElementById("rateDate"),
  statusDot: document.getElementById("statusDot"),
  statusText: document.getElementById("statusText"),
  errBox: document.getElementById("errBox"),
  btn30: document.getElementById("btn30"),
  btn15: document.getElementById("btn15"),
  canvas: document.getElementById("rateChart"),
  rangeLabel: document.getElementById("rangeLabel")
};

let activeKey = "30";
let chartState = { points: [] };

function setStatus(ok, text){
  el.statusText.textContent = text;
  el.statusDot.classList.toggle("bad", !ok);
}

function showError(msg){
  el.errBox.style.display = "block";
  el.errBox.textContent = msg;
  setStatus(false, "Unavailable");
}

function clearError(){
  el.errBox.style.display = "none";
  el.errBox.textContent = "";
}

function endpointFor(key){
  return key === "30" ? ENDPOINT_30 : ENDPOINT_15;
}

async function fetchSeries(key){
  const url = endpointFor(key);
  const res = await fetch(url, { cache: "no-store" });
  if (!res.ok) throw new Error(`HTTP ${res.status}`);
  const data = await res.json();

  /**
   * Supported payload shapes:
   * A) Current-only:
   *   { ok:true, series:"MORTGAGE30US", rate:6.09, date:"2026-02-12", source:"FRED" }
   *
   * B) With history:
   *   { ok:true, series:"MORTGAGE30US", rate:6.09, date:"2026-02-12",
   *     history:[{date:"2025-03-01", value:6.7}, ...] }
   *
   * C) Alternate:
   *   { observations:[{date:"...", value:"6.09"}, ...] }
   */
  const out = { currentRate: null, currentDate: null, points: [] };

  if (typeof data.rate === "number" && data.date){
    out.currentRate = data.rate;
    out.currentDate = data.date;
  }

  if (Array.isArray(data.history)){
    out.points = data.history
      .map(p => ({ date: p.date, value: Number(p.value) }))
      .filter(p => Number.isFinite(p.value) && p.date);
  } else if (Array.isArray(data.observations)){
    out.points = data.observations
      .map(p => ({ date: p.date, value: Number(p.value) }))
      .filter(p => Number.isFinite(p.value) && p.date);
  }

  // If we have points but no currentRate, use last point
  if (out.points.length && (out.currentRate === null || !out.currentDate)){
    const last = out.points[out.points.length - 1];
    out.currentRate = last.value;
    out.currentDate = last.date;
  }

  if (out.currentRate === null || !out.currentDate){
    throw new Error("Missing rate/date in response.");
  }

  return out;
}

function fmtDate(iso){
  try{
    const d = new Date(iso + "T00:00:00Z");
    return d.toLocaleDateString(undefined, { year:"numeric", month:"short", day:"numeric" });
  }catch{
    return iso;
  }
}

function setActive(key){
  activeKey = key;
  el.btn30.classList.toggle("active", key === "30");
  el.btn15.classList.toggle("active", key === "15");
  el.btn30.setAttribute("aria-selected", key === "30" ? "true" : "false");
  el.btn15.setAttribute("aria-selected", key === "15" ? "true" : "false");
  el.title.textContent = SERIES[key].name;
  loadAndRender();
}

function drawChart(points){
  const canvas = el.canvas;
  const ctx = canvas.getContext("2d");

  // Handle DPR scaling
  const dpr = Math.max(1, Math.floor(window.devicePixelRatio || 1));
  const cssW = canvas.clientWidth;
  const cssH = canvas.clientHeight;
  canvas.width = Math.floor(cssW * dpr);
  canvas.height = Math.floor(cssH * dpr);
  ctx.setTransform(dpr, 0, 0, dpr, 0, 0);

  ctx.clearRect(0,0,cssW,cssH);

  const pad = { l: 14, r: 14, t: 14, b: 18 };
  const W = cssW, H = cssH;
  const innerW = W - pad.l - pad.r;
  const innerH = H - pad.t - pad.b;

  // Background grid
  ctx.strokeStyle = "rgba(255,255,255,.08)";
  ctx.lineWidth = 1;
  const gridLines = 4;
  for (let i=1; i<=gridLines; i++){
    const y = pad.t + (innerH * i / (gridLines+1));
    ctx.beginPath();
    ctx.moveTo(pad.l, y);
    ctx.lineTo(W - pad.r, y);
    ctx.stroke();
  }

  if (!points || points.length < 2){
    ctx.fillStyle = "rgba(255,255,255,.55)";
    ctx.font = "600 13px ui-sans-serif, system-ui";
    ctx.fillText("Not enough history to plot.", pad.l, pad.t + 18);
    el.rangeLabel.textContent = "Range: —";
    return;
  }

  const vals = points.map(p => p.value);
  const min = Math.min(...vals);
  const max = Math.max(...vals);

  const yMin = min - 0.15;
  const yMax = max + 0.15;

  function xAt(i){
    return pad.l + (innerW * (i / (points.length - 1)));
  }
  function yAt(v){
    const t = (v - yMin) / (yMax - yMin || 1);
    return pad.t + innerH - (innerH * t);
  }

  // Line (gold)
  ctx.strokeStyle = "rgba(210,181,108,.95)";
  ctx.lineWidth = 2;
  ctx.beginPath();
  for (let i=0; i<points.length; i++){
    const x = xAt(i);
    const y = yAt(points[i].value);
    if (i === 0) ctx.moveTo(x,y);
    else ctx.lineTo(x,y);
  }
  ctx.stroke();

  // Fill under line
  ctx.fillStyle = "rgba(210,181,108,.12)";
  ctx.beginPath();
  for (let i=0; i<points.length; i++){
    const x = xAt(i);
    const y = yAt(points[i].value);
    if (i === 0) ctx.moveTo(x,y);
    else ctx.lineTo(x,y);
  }
  ctx.lineTo(xAt(points.length - 1), pad.t + innerH);
  ctx.lineTo(xAt(0), pad.t + innerH);
  ctx.closePath();
  ctx.fill();

  // Endpoint dot
  const last = points[points.length - 1];
  const lx = xAt(points.length - 1);
  const ly = yAt(last.value);
  ctx.fillStyle = "rgba(210,181,108,1)";
  ctx.beginPath();
  ctx.arc(lx, ly, 4.2, 0, Math.PI * 2);
  ctx.fill();

  el.rangeLabel.textContent = `Range: ${min.toFixed(2)}% – ${max.toFixed(2)}%`;
}

async function loadAndRender(){
  clearError();
  setStatus(true, "Loading…");
  el.rateValue.textContent = "--";
  el.rateDate.textContent = "—";

  try{
    const result = await fetchSeries(activeKey);

    el.rateValue.textContent = result.currentRate.toFixed(2) + "%";
    el.rateDate.textContent = "As of " + fmtDate(result.currentDate);
    setStatus(true, "Live");

    chartState.points = (result.points || []).slice(-HISTORY_POINTS);
    drawChart(chartState.points);

  } catch (e){
    console.error(e);
    showError("Mortgage rate data is currently unavailable. Please refresh or try again later.");
    drawChart([]);
  }
}

// Toggle handlers
el.btn30.addEventListener("click", () => setActive("30"));
el.btn15.addEventListener("click", () => setActive("15"));

// Redraw chart on resize
window.addEventListener("resize", () => {
  drawChart(chartState.points || []);
});

// Initial load
loadAndRender();


/* ============================= */
/* MARKET ROTATOR (unchanged) */
/* ============================= */

const markets = {
  "White House (37188)": [
    { label:"Pricing Trends", url:"https://go.realtracs.com/1evji2y"},
    { label:"Price per Sqft", url:"https://go.realtracs.com/1evjUG3"},
    { label:"DOM", url:"https://go.realtracs.com/1evjb2g"},
    { label:"Showings", url:"https://go.realtracs.com/1evjhE7"},
    { label:"Months Supply", url:"https://go.realtracs.com/1evjm6O"},
    { label:"Market Inventory", url:"https://go.realtracs.com/1evjo1D"},
  ],
  "Robertson County": [
    { label:"Pricing Trends", url:"https://go.realtracs.com/1evlNAJ"},
    { label:"Price per Sqft", url:"https://go.realtracs.com/1evlX6f"},
    { label:"DOM", url:"https://go.realtracs.com/1evlTFp"},
    { label:"Showings", url:"https://go.realtracs.com/1evlcFx"},
  ],
  "Sumner County": [
    { label:"Pricing Trends", url:"https://go.realtracs.com/1evlq6b"},
    { label:"Price per Sqft", url:"https://go.realtracs.com/1evlu8q"},
    { label:"DOM", url:"https://go.realtracs.com/1evlhDS"},
    { label:"Showings", url:"https://go.realtracs.com/1evle3V"},
  ]
};

const select = document.getElementById("marketSelect");
const frameHost = document.getElementById("frameHost");
const indicator = document.getElementById("indicator");
const btnPrev = document.getElementById("btnPrev");
const btnNext = document.getElementById("btnNext");

let frames = [];
let currentIndex = 0;
let currentMarket = null;

function populateDropdown(){
    Object.keys(markets).forEach(name=>{
        const opt=document.createElement("option");
        opt.value=name;
        opt.textContent=name;
        select.appendChild(opt);
    });
}

function buildIframes(market){
    frames.forEach(f=>f.remove());
    frames=[];
    currentMarket=market;
    markets[market].forEach(chart=>{
        const iframe=document.createElement("iframe");
        iframe.src=chart.url;
        frameHost.insertBefore(iframe, btnPrev);
        frames.push(iframe);
    });
    currentIndex=0;
    showFrame(0);
}

function showFrame(idx){
    frames.forEach((f,i)=>f.classList.toggle("active",i===idx));
    indicator.textContent = markets[currentMarket][idx].label;
}

btnNext.onclick=()=>{
    currentIndex=(currentIndex+1)%frames.length;
    showFrame(currentIndex);
};

btnPrev.onclick=()=>{
    currentIndex=(currentIndex-1+frames.length)%frames.length;
    showFrame(currentIndex);
};

select.addEventListener("change",()=>buildIframes(select.value));

populateDropdown();
select.value="White House (37188)";
buildIframes(select.value);

</script>

</body>
</html>
